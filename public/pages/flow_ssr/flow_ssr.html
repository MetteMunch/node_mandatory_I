<!doctype html>
<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <title>Flow og opbygning - Serverside Rendering (SSR) med Egen Engine</title>
    <link rel="stylesheet" href="../../assets/css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="content">
      <h1>Flow og opbygning - SSR Server-side Rendering </h1>

      <p>
        Med udgangspunkt i en lille vejr applikation
        <strong>Node.js (Express)</strong>, vil jeg pr√∏ve at beskrive
        opbygningen af applikationen samt hvad sker hvor (client-side og
        server-side). Denne server-side rendering sker vha en simpel template 
        engine (`constructPage`), som vi selv har konstrueret. Der kan ogs√• benyttes
        indl√¶ste template engines, som fx EJS (Embedded JavaScript Templating). 
        Her ved server-side rendering genereres hele siden p√• serveren, hvor de dynamiske 
        data erstatter <strong>specialtegn</strong> i HTML-skabelonerne, f√∏r siden sendes 
        til clienten / browseren.
      </p>
      <br />

      <h2>1Ô∏è‚É£ Bruger kalder <code>/weather/:city</code></h2>
      <p>
        Bruger g√•r ind p√• fx <code>http://localhost:8080/weather/k√∏benhavn</code>. 
        Denne route h√•ndteres i serverens PAGES-logik.
      </p>

      <pre><code class="language-javascript">
        // app.js (PAGES-delen)
        app.get("/weather/:city", async (req, res) => {
        const city = req.params.city;
        const finalHTML = await weatherPage(city);
        res.send(finalHTML); // Returner den f√¶rdigbyggede HTML-streng
        });
      </code></pre>

      <h2>2Ô∏è‚É£ Serveren henter data og konstruerer HTML-siden</h2>
      <p>
        <strong>PAGES-routen</strong> kalder weatherPage() funktionen i
        <strong>pagesUtil.js</strong> p√• serveren. Denne funktion st√•r for b√•de 
        at lave kald til <strong>weatherUtil.js</strong> som henter data fra ekstern API og
        kalde vores templateEngine, s√• HTML filen kan samles med korrekt data.
        </p>

      <pre><code class="language-javascript">
      // util/pagesUtil.js 

      import { readPage, constructPage } from "./templatingEngine.js";
      import { getWeather } from "./weatherUtil.js"; 

      // En funktion til at konstruere vejr-siden dynamisk
      export async function weatherPage(city) {
          // 1. Her hentes data. Asynkront s√• koden k√∏rer f√∏rst videre, n√•r vi har data
          const weatherData = await getWeather(city); 

          // 2. Her indl√¶ses html skabelonens indhold (weather.html) via kald til 
          // template engine og funktionen readPage(). Det er en html-streng
          // indeholdende placeholders (her $$CITY_NAME$$ og $$TEMPERATURE$$)
          const weatherContent = readPage("./public/pages/weather/weather.html");
          
          // 3. Konverter hentet data til HTML-strenge
          const cityTitle = city.charAt(0).toUpperCase() + city.slice(1);
          const tempValue = weatherData.CurrentData.temperature + "¬∞C";

          // 4. Her erstattes placeholders i html siden med hentet data
          const contentWithData = weatherContent
              .replace('$$CITY_NAME$$', cityTitle)
              .replace('$$TEMPERATURE$$', tempValue);

          // 5. Nu har vi den f√¶rdige indholdsstreng (contentWithData), og selve 
          // den fulde html side skal samles (header + indhold + footer) via kald til 
          // template engine og funktionen constructPage.
          return constructPage(contentWithData, { 
              tabTitle: `Vejret i ${cityTitle}`,
              cssLinks: `<link rel="stylesheet" href="/pages/weather/weather.css">`
          }); 
      }
      </code></pre>

      <h2> Serverens <code>weatherUtil.js</code> henter data fra ekstern API</h2>
      <p>
        N√•r funktionen kaldes i trin 2 s√• igangs√¶tter det datahentningen fra esktern API via 
        <strong>weatherUtil.js</strong> og funktionen <strong>getWeather()</strong>. 
        Data returneres til weatherPage(city) i pagesUtil.js som samler det hele.
      </p>

      <pre><code class="language-javascript">
      // utils/weatherUtil.js

      export async function getWeather(city) {
      const url = `https://vejr.eu/api.php?location=${city}&degree=C`;
      const response = await fetch(url);
      const data = await response.json();
      return data;
      }
  
      </code></pre><br>    
      <h2> Serverens <code>templateEngine.js</code> muligg√∏r samling af korrekt data</h2>
      <p>
        N√•r funktionen kaldes i trin 2, og data modtages fra ekstern API, s√• s√∏rger kald til 
        <strong>constructPage()</strong> i <strong>templateEngine.js</strong> for at
        det er muligt at samle html-siden, hvis man som her fx har opdelt i en header.html, footer.html 
        samt at content bliver med korrekt dynamisk data i pageContent i den prim√¶re html fil, 
        som her er weather.html.
      </p>  

      <pre><code class="language-javascript">
      //util/templateEngine.js

      import fs from 'fs';      

      const header = readPage("./public/components/header/header.html");
      const footer = readPage("./public/components/footer/footer.html");

      export function constructPage(pageContent, options = {}) {
          return header 
          .replace('$$TAB_TITLE$$', options.tabTitle || "Vejret")
          .replace('$$CSS_LINKS$$', options.cssLinks || "")
          + pageContent
          + footer;
      }      

      export function readPage(path) {
          return fs.readFileSync(path).toString();
      }
      </code></pre><br>

      <h2>3Ô∏è‚É£ Serveren returnerer den f√¶rdige HTML-side</h2>
      <p>
        Serveren sender den komplette HTML-streng, der er blevet samlet i
        `constructPage` og `weatherPage`. Browseren modtager HTML, hvor de dynamiske data
        allerede er indsat.
      </p>
      
      <h2>4Ô∏è‚É£ Browser viser data (straks)</h2>
      <p>
        Browseren modtager HTML, der er 100% klar. Der er intet JavaScript
        n√∏dvendigt p√• klientsiden for at hente eller inds√¶tte data.
      </p>

      <br />

      <h2>üìò Samlet flow (kort fortalt for SSR med Egen Engine)</h2>

      <table>
        <thead>
          <tr>
            <th>Trin</th>
            <th>Hvad sker der</th>
            <th>Hvor</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>Bruger √•bner <code>/weather/k√∏benhavn</code></td>
            <td>Client ‚Üí Server</td>
          </tr>
          <tr>
            <td>2</td>
            <td>Server kalder <code>weatherUtil.js</code> for at hente data</td>
            <td>Server</td>
          </tr>
          <tr>
            <td>3</td>
            <td>Serveren kalder <code>readPage</code> (egen Engine) for at indl√¶se html</td>
            <td>Server</td>
          </tr>
          <tr>
            <td>4</td>
            <td>Serveren erstatter placeholders med data</td>
            <td>Server</td>
          </tr>
          <tr>
            <td>5</td>
            <td>Serveren kalder <code>constructPage</code> (egen Engine) for at samle den f√¶rdige html side</td>
            <td>Server</td>
          </tr>
          <tr>
            <td>6</td>
            <td>Server returnerer den f√¶rdige HTML-streng</td>
            <td>Server ‚Üí Client</td>
          </tr>
          <tr>
            <td>7</td>
            <td>Browser viser data √∏jeblikkeligt</td>
            <td>Client</td>
          </tr>
        </tbody>
      </table>
      <br />

      <a class="back" href="/">‚¨Ö Tilbage til opslagstavlen</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-html.min.js"></script>
  </body>
</html>